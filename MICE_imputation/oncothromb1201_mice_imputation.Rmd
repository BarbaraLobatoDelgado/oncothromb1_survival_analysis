---
title: "MICE imputation of Oncothromb12-01"
output: html_notebook
---

# User-defined functions

```{r}
# Function to check proportion of missing data per column/row
#proportion_missing_values <- function(x) {sum(is.na(x))/length(x)*100}
#sum(apply(whole_imputed_data, 2, proportion_missing_values))
# Missing data proportion by column
#apply(whole_imputed_data, 2, proportion_missing_values) # Remove columns related to VTE events
```


```{r}
require(tidyverse)
require(rcompanion)


# Calculate a pairwise association between all variables in a data-frame. In particular nominal vs nominal with Chi-square, numeric vs numeric with Pearson correlation, and nominal vs numeric with ANOVA.
# Adopted from https://stackoverflow.com/a/52557631/590437
mixed_assoc = function(df, cor_method="spearman", adjust_cramersv_bias=TRUE){
    df_comb = expand.grid(names(df), names(df),  stringsAsFactors = F) %>% 
      purrr::set_names("X1", "X2")

    is_nominal = function(x) class(x) %in% c("factor", "character")
    # https://community.rstudio.com/t/why-is-purr-is-numeric-deprecated/3559
    # https://github.com/r-lib/rlang/issues/781
    is_numeric <- function(x) { is.integer(x) || is_double(x)}

    f = function(xName,yName) {
        x =  pull(df, xName)
        y =  pull(df, yName)

        result = if(is_nominal(x) && is_nominal(y)){
            # use bias corrected cramersV as described in https://rdrr.io/cran/rcompanion/man/cramerV.html
            cv = rcompanion::cramerV(as.character(x), as.character(y), bias.correct = adjust_cramersv_bias)
            data.frame(xName, yName, assoc=cv, type="cramersV")

        }else if(is_numeric(x) && is_numeric(y)){
            correlation = cor(x, y, method=cor_method, use="complete.obs")
            data.frame(xName, yName, assoc=correlation, type="correlation")

        }else if(is_numeric(x) && is_nominal(y)){
            # from https://stats.stackexchange.com/questions/119835/correlation-between-a-nominal-iv-and-a-continuous-dv-variable/124618#124618
            r_squared = summary(lm(x ~ y))$r.squared
            data.frame(xName, yName, assoc=sqrt(r_squared), type="anova")

        }else if(is_nominal(x) && is_numeric(y)){
            r_squared = summary(lm(y ~x))$r.squared
            data.frame(xName, yName, assoc=sqrt(r_squared), type="anova")

        }else {
            warning(paste("unmatched column type combination: ", class(x), class(y)))
        }

        # finally add complete obs number and ratio to table
        result %>% mutate(complete_obs_pairs=sum(!is.na(x) & !is.na(y)), complete_obs_ratio=complete_obs_pairs/length(x)) %>% rename(x=xName, y=yName)
    }

    # apply function to each variable combination
    map2_df(df_comb$X1, df_comb$X2, f)
}
```

# Load libraries

```{r, message=FALSE}
library(an9elproject)
library(an9elversions)
library(tidyverse)
library(lubridate)
library(magrittr)
library(naniar)
library(mice)
library(survival)
library(mctest)
library(ggcorrplot)
```


# Load data

```{r}
oncoth1 = get_project("oncoth1", version = "0.0.8017", baseDir = "./oncoth1_versions/")
```


# Inspect missing data

```{r, warning=FALSE, fig.height=8, fig.width=7}
oncoth1$data %>%
  select(!c(anticoag_tx_lmwh_dosage, 
            anticoag_tx_vte_drugs, 
            vte_before_entering_study)) %>%
  select(!contains("reason")) %>%
  select(!contains("date")) %>%
  select(!starts_with("type_")) %>%
  select(!starts_with("cancer_associated_")) %>%
  select(!starts_with("eval_")) %>%
  select(!starts_with("rec_")) %>%
  select(!contains("prior_study")) %>%
  select(!contains("along_study")) %>%
  select(!contains("_recurrence")) %>%
  select(!contains("time_until_")) %>%
  select_if( ~ any(is.na(.))) %>%
  gg_miss_var(., show_pct = TRUE)

```


```{r}
md.pattern(
  oncoth1$data %>% select(
    #aptt, 
    #aptt_ratio,
    diabetes_mellitus,
    dyslipidemia,
    tobacco_use,
    copd,
    arterial_hypertension,
    chronic_cardiac_insufficiency,
    renal_insufficiency, 
    venous_insufficiency, 
    catheter_device
  ), 
rotate.names = TRUE)
```


All these variables (except tobacco_use and venous_insufficiency) have missing values missing not at random (MNAR).  


# Subset for multivariate CPH regression

Virtually every dataset contains some parts that could better be removed before imputation. This includes, but is not limited to, uninteresting variables with a high proportion of missing data, variables without a code for the missing data, administrative variables, constant variables, duplicated, recoded or standardized variables, and aggregates and indices of other information.


```{r}
multivariate_cph_data = oncoth1$data %>%
  select(id, 
         patient_group,
         patient_status_at_end_study,
         age_when_cancer_dx, 
         gender, 
         menopausal_status, 
         pregnancy,
         oral_contraceptive_tx, 
         weight,
         height,
         body_surface_area, # collinear with bmi and somewhat with creatinine
         bmi_value,
         bmi_category, #
         performance_status_category_corrected, 
         albumin, 
         aptt,
         aptt_ratio, 
         bilirubin, 
         creatinine, 
         alkaline_phosphatase, 
         hemoglobin, #
         inr, 
         leukocytes, 
         platelets,
         leukocytosis, 
         thrombocytosis, # quitar
         low_hemoglobin, # quitar
         personal_background, # causes trouble I don't know why
         hormone_therapy,
         #diabetes_mellitus,
         #dyslipidemia, 
         tobacco_use,
         venous_insufficiency,
         primary_tumor_simplified,
         progression_according_to_clinical_stage, 
         tnm_stage,
         #tnm_stage_grouped, # fix manually according to tnm_stage_grouped
         t_stage, 
         #t_stage_grouped, # fix manually according to t_stage
         n_stage, 
         #n_stage_grouped, # fix manually according to n_stage
         histology_type, 
         mucinous_histology, 
         grade_histological_differentiation, 
         metastasis_dx,
         n_metastases,
         catheter_device, 
         khorana_risk_score, 
         tic_onco
)
```


```{r}
multivariate_cph_data %<>%
  mutate(patient_status_at_end_study = word(patient_status_at_end_study, 1)) %>%
  mutate(patient_status_at_end_study = as.factor(patient_status_at_end_study))
```



```{r, fig.width=8}
# Look for MNAR patterns
#md.pattern(multivariate_cph_data, rotate.names = TRUE) # too big
```


```{r}
# Collinear data 
numeric_collinearity = cor(
  Filter(is.numeric, multivariate_cph_data), 
  use = "pairwise.complete.obs"
  )
```


```{r}
# Cramers V test
#mixed_assoc_results = mixed_assoc(df = multivariate_cph_data[, -c(1)])
```


```{r}
# One-hot encoding of categorical variables
#correlation_all_vars = model.matrix(~0+., data=multivariate_cph_data[, -c(1:3)]) %>% 
#  cor(use="pairwise.complete.obs")
```


```{r}
# One-hot encoding of categorical variables and corrplot
#model.matrix(~0+., data=multivariate_cph_data) %>% # one-hot encoding
  #cor(use="pairwise.complete.obs") %>% 
  #ggcorrplot(show.diag = F, type="lower", lab=TRUE, lab_size=2, tl.cex = 6)
```


```{r}
dataset_flux = flux(multivariate_cph_data)
```

The influx of a variable quantifies how well its missing data connect to the observed data on other variables. The outflux of a variable quantifies how well its observed data connect to the missing data on other variables. Variables with higher outflux are (potentially) the more powerful predictors. Variables with higher influx depend strongly on the imputation model.    

The group at the left-upper corner has (almost) complete information, so the number of missing data problems for this group is relatively small. The intermediate group has an outflux between 0.5 and 0.8, which is small. Missing data problems are more severe, but potentially this group could contain important variables. The third group has an outflux with 0.5 and lower, so its predictive power is limited.  

Variables that might cause problems later on in the imputations are located in the lower-right corner.

```{r}
fluxplot(multivariate_cph_data, ylim = c(0, 1.05), cex = 0.7, eqscplot = TRUE)
```

All points are relatively close to the diagonal, which indicates that influx and outflux are balanced.  


# Imputation of missing values


```{r}
# Detects oral_contraceptive_tx as collinear and eliminates it from imputation
init = mice(multivariate_cph_data, maxit = 0, seed = 2828) 
meth = init$method
predM = init$predictorMatrix
```

As a general rule, using every bit of available information yields multiple imputations that have minimal bias and maximal efficiency.  

It is often beneficial to choose as large a number of predictors as possible. Including as many predictors as possible tends to make the MAR assumption more plausible, thus reducing the need to make special adjustments for MNAR mechanisms.  

For imputation purposes, it is expedient to select a suitable subset of data that contains no more than 15 to 25 variables.  


```{r}
# Reintroduce variable to be imputed
meth["oral_contraceptive_tx"] = "polyreg"
```


```{r}
print(meth)
```

```{r}
# Use of quickpred to obtain prediction matrix
predM = quickpred(
  multivariate_cph_data, 
  mincor = 0.2,
  minpuc = 0.5, 
  include = c("patient_group", "patient_status_at_end_study")
  )
```


```{r}
# Tweak prediction matrix
predM[, c("id",
          #"gender", # Do not remove if you want post-imputation to work correctly
          "albumin",
          "inr",
          "aptt",
          "aptt_ratio", 
          "pregnancy", 
          "oral_contraceptive_tx",
          "performance_status_category_corrected", 
          "personal_background",
          "t_stage", 
          "metastasis_dx", 
          "n_metastases")] = 0
```


```{r}
# Add certain variables as predictors of other variables
#predM["menopausal_status", "age_when_cancer_dx"] = 1
#predM["menopausal_status", "performance_status_category_corrected"] = 1
predM["leukocytosis", "leukocytes"] = 1
```


```{r}
# Distribution of number of predictions
table(rowSums(predM))
```

```{r}
# The names of the predictors for any give variable can be obtained by
names(multivariate_cph_data)[predM["oral_contraceptive_tx", ] == 1]
```


```{r}
visit = init$visitSequence
#visit = append(visit, "menopausal_status")
visit
```


```{r}
post <- init$post

post["menopausal_status"] <- "imp[[j]][data$gender[!r[, j]] == 'Male', i] <- 'Male'"
post["pregnancy"] <- "imp[[j]][data$gender[!r[, j]] == 'Male', i] <- 'Male'"
post["oral_contraceptive_tx"] <- "imp[[j]][data$gender[!r[, j]] == 'Male', i] <- 'Male'"

```


```{r}
imputed = mice(
  multivariate_cph_data, 
  method = meth, 
  predictorMatrix = predM, 
  visitSequence = visit,
  post = post,
  m = 10, 
  seed = 2828
  )
```


```{r}
plot(imputed, c(
  "menopausal_status", 
  "performance_status_category_corrected",  
  "albumin",  
  "aptt",  
  "aptt_ratio",  
  "bilirubin",  
  "creatinine",  
  "alkaline_phosphatase",  
  "inr", 
  "leukocytes",  
  "leukocytosis",  
  "hormone_therapy",  
  "pregnancy",  
  "oral_contraceptive_tx",
  "tobacco_use",  
  "venous_insufficiency",  
  "progression_according_to_clinical_stage",  
  "t_stage",  
  "n_stage",  
  "histology_type",  
  "mucinous_histology",  
  "grade_histological_differentiation",  
  "catheter_device",  
  "khorana_risk_score",  
  "tic_onco"
  ))
```


```{r}
whole_imputed_data = complete(imputed)
```


```{r}
md.pattern(whole_imputed_data, rotate.names = TRUE)
```


```{r}
densityplot(imputed)
```


```{r}
stripplot(imputed, pch = 20, cex = 1.2)
```


## Review imputation results

```{r}
# Matrix with all imputed values
imputation_data_long = complete(imputed, "long")
```


## Input merged variables in oncoth1 object

```{r}
# Create columns with imputed data
 whole_imputed_data %<>% 
  mutate(across(c(menopausal_status, 
         performance_status_category_corrected, 
         albumin, 
         aptt,
         aptt_ratio, 
         bilirubin, 
         creatinine, 
         alkaline_phosphatase, 
         inr, 
         leukocytes, 
         leukocytosis, 
         hormone_therapy, 
         pregnancy, 
         tobacco_use, 
         venous_insufficiency, 
         progression_according_to_clinical_stage, 
         t_stage, 
         n_stage, 
         histology_type, 
         mucinous_histology, 
         grade_histological_differentiation, 
         metastasis_dx, 
         catheter_device, 
         khorana_risk_score, 
         tic_onco), ~ .x, .names = "{col}_imp")) %>%
  select(id | ends_with("_imp")) 

```


```{r}
#write.csv(whole_imputed_data, file = "./oncoth1_mice_imputation_values.csv")
```


```{r}
# Inspect multicollineatiry between variables
#mixed_assoc_results_imp = mixed_assoc(df = whole_imputed_data[, -c(1)]) 
```






