---
title: 'Survival analysis of ONCOTHROMB12-01 cohort'
author: "BÃ¡rbara Lobato Delgado"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r}
# Deactivate scientific notation
options(scipen = 999, max.print = 10000)
```


```{r}
# knitr::knit_hooks$set(output = function(x, options) {
#    max.lines <- options$max.lines
#    x <- truncate_to_lines(x, max.lines)
# 
#    hook_output_default(x, options)
# })
```


```{r}
# Load libraries
pacman::p_load(
  kableExtra,
  an9elproject, 
  tidyverse,
  lubridate, 
  magrittr,
  survival,
  survminer, 
  car,
  StepReg,
  install = FALSE, update = FALSE
  )
```


# Load data

```{r}
# Load DB
oncoth1 = get_project("oncothr1", version = "0.0.8004")
```


```{r}
# Get data slot
oncoth1_data = oncoth1$data
```


```{r}
# Group tobacco use into 'Never smoked' vs 'Former/current'
oncoth1_data %<>%
  mutate(tobacco_use_imp_grouped = case_when(
    tobacco_use_imp == "Never has smoked" ~ "Never", 
    tobacco_use_imp == "Former smoker" ~ "Former/current",
    tobacco_use_imp == "Active smoker" ~ "Former/current"), 
    .after = tobacco_use_imp)

# Create quartiles for age 
oncoth1_data %<>%
  mutate(age_quartiles = case_when(
    age_when_cancer_dx <= 60 ~ "33-60", 
    age_when_cancer_dx > 60 & age_when_cancer_dx <= 69 ~ "61-69",
    age_when_cancer_dx >= 70 ~ "70-93"
  ), .after = age_when_cancer_dx) %>%
  mutate(age_quartiles = as.factor(age_quartiles))
```


```{r}
# Correct ties between death date and DVT date
# THIS IS NOT NECESSARY IF TIES ARE BETWEEN EVENT AND TDC
#oncoth1_data %<>%
#  mutate(follow_up_length_from_cancer_diagnosis_days = case_when(
#    id == 60 | 
#      id == 246 | 
#      id == 248 | 
#      id == 286 |
#      id == 296 |
#      id == 363 |
#      id == 441 ~ follow_up_length_from_cancer_diagnosis_days + 0.5, 
#    TRUE ~ follow_up_length_from_cancer_diagnosis_days))
```


# Create dataset for survival analysis

This dataset must be in the proper format to deal with time-dependent covariates and left- and right-censoring. The function `survival::tmerge()` helps us with it. 

```{r}
# Get subset of covariates for survival analysis
covariates_df = oncoth1_data %>%
  select(id, 
         patient_group,
         age_when_cancer_dx,
         age_quartiles,
         age_when_cancer_dx_50,
         age_when_cancer_dx_65,
         gender, 
         ethnicity,
         ethnicity_grouped,
         menopausal_status_imp,
         weight, 
         height, 
         body_surface_area,
         bmi_value,
         bmi_category, 
         performance_status_category_corrected_imp,
         hormone_therapy,
         major_surgery_in_medical_history, 
         pregnancy_imp, 
         oral_contraceptive_tx, 
         diabetes_mellitus, 
         dyslipidemia, 
         tobacco_use_imp, 
         tobacco_use_imp_grouped,
         copd_imp, 
         arterial_hypertension, 
         chronic_cardiac_insufficiency, 
         renal_insufficiency, 
         khorana_risk_score_imp,
         krs_category, 
         two_groups_krs, 
         tic_onco_imp,
         previous_onco_surgery, 
         primary_tumor_simplified, 
         tumor_surgically_removed, 
         progression_according_to_clinical_stage_imp, 
         tnm_stage, 
         tnm_stage_detailed, 
         tnm_stage_grouped, 
         tnm_stage_two_groups,
         t_stage_imp, 
         t_stage_grouped,
         n_stage_imp, 
         n_stage_grouped,
         m_stage, 
         m_stage_grouped,
         histology_type_imp, 
         mucinous_histology_imp, 
         grade_histological_differentiation_imp, 
         n_metastases,
         n_metastases_grouped,
         metastasis_adrenal_glands, 
         metastasis_bones,                             
         metastasis_brain,                               
         metastasis_liver,                               
         metastasis_lung,                                
         metastasis_lymph_nodes,                         
         metastasis_peritoneum,                          
         metastasis_pleura,                              
         metastasis_skin,                                
         metastasis_soft_tissues,                        
         other_metastases,
         catheter_device_imp,
         venous_insufficiency_imp,
         n_comorbidities,
         family_background_vte,
         family_background_vte_n,
         family_background_vte_all_relatives,
         family_background_VTE_father,    
         family_background_VTE_mother,  
         family_background_VTE_siblings, 
         family_background_VTE_offspring, 
         family_background_VTE_other_relatives, 
         previous_vte, 
         previous_ate,
         n_previous_ate,
         previous_ate_type,
         cva_ate,
         myocardial_infarction_ate, 
         pad_ate, 
         tia_ate, 
         other_thromb_ate, 
         anticoag_tx_vte,                                
         anticoag_tx_vte_drugs,                          
         anticoag_tx_cardiopathy,
         anticoag_tx_other_causes, 
         anticoag_tx_reason, 
         anticoag_tx_apixaban,                           
         anticoag_tx_dabigatran,                         
         anticoag_tx_lmwh,                               
         anticoag_tx_lmwh_dosage,                        
         anticoag_tx_vit_k_antag,                        
         anticoag_tx_other_drugs,                        
         anticoag_tx_currently,
         n_antiaggreg_tx, 
         antiaggreg_tx_reason,
         antiaggreg_tx_cardiopathy,                      
         antiaggreg_tx_cva,                              
         antiaggreg_tx_other_causes,
         antiaggreg_tx_currently, 
         tu_1st_blood_transfusion_from_cancer_diagnosis_days, 
         tu_2nd_blood_transfusion_from_cancer_diagnosis_days, 
         tu_3rd_blood_transfusion_from_cancer_diagnosis_days, 
         tu_1st_major_trauma_from_cancer_diagnosis_days, 
         tu_1st_immobilisation_from_cancer_diagnosis_days, 
         tu_2nd_immobilisation_from_cancer_diagnosis_days, 
         tu_3rd_immobilisation_from_cancer_diagnosis_days, 
         tu_1st_recent_major_surgery_from_cancer_diagnosis_days, 
         tu_2nd_recent_major_surgery_from_cancer_diagnosis_days, 
         tu_3rd_recent_major_surgery_from_cancer_diagnosis_days, 
         tu_1st_thromboprophylaxis_hospital_from_cancer_diagnosis_days, 
         tu_1st_erythropoietin_tx_from_cancer_diagnosis_days, 
         tu_2nd_erythropoietin_tx_from_cancer_diagnosis_days, 
         tu_3rd_erythropoietin_tx_from_cancer_diagnosis_days, 
         vte_recurrence)
```


```{r}
# Get subset of variables containing information about patient status and time until events
survival_data = oncoth1_data %>%
  select(id, 
         patient_group, 
         date_cancer_dx, 
         date_study_begins, 
         date_study_ends,
         date_death,
         patient_status_at_end_study, 
         censored_patient, 
         follow_up_length_from_cancer_diagnosis_days, 
         follow_up_length_from_cancer_diagnosis_months,
         tu_1st_vte_all_from_cancer_diagnosis_days_corrected,
         tu_1st_vte_all_from_cancer_diagnosis_months_corrected, 
         tu_2nd_vte_all_from_cancer_diagnosis_days_corrected, 
         tu_2nd_vte_all_from_cancer_diagnosis_months_corrected, 
         tu_3rd_vte_all_from_cancer_diagnosis_days_corrected, 
         tu_3rd_vte_all_from_cancer_diagnosis_months_corrected, 
         tu_4th_vte_all_from_cancer_diagnosis_days_corrected, 
         tu_4th_vte_all_from_cancer_diagnosis_months_corrected
         )
```


```{r}
# Create object tmerge for managing time-dependant covariates 
# Add time until death/censoring and time until VTE
# For interval censored data, the status indicator is 
# 0=right censored
# 1=event at time 
# 2=left censored
# 3=interval censored
survival_vte_tmerge = tmerge(
  data1 = covariates_df, 
  data2 = survival_data, 
  id = id, 
  tstop = follow_up_length_from_cancer_diagnosis_days, 
  # event() is the survival analysis event of interest (in our case, death)
  death = event(follow_up_length_from_cancer_diagnosis_days, censored_patient), 
  # tdc() are for time-dependent covariates
  vte_event = tdc(tu_1st_vte_all_from_cancer_diagnosis_days_corrected),
  vte_event = tdc(tu_2nd_vte_all_from_cancer_diagnosis_days_corrected),
  vte_event = tdc(tu_3rd_vte_all_from_cancer_diagnosis_days_corrected),
  vte_event = tdc(tu_4th_vte_all_from_cancer_diagnosis_days_corrected)
  )
```


```{r}
# Add other time-dependent covariates (i.e., blood transfusion, immobilisation, etc.)
survival_vte_tmerge = tmerge(
  survival_vte_tmerge, 
  survival_vte_tmerge, 
  id = id, 
  blood_transfusion = tdc(tu_1st_blood_transfusion_from_cancer_diagnosis_days),
  blood_transfusion = tdc(tu_2nd_blood_transfusion_from_cancer_diagnosis_days),
  blood_transfusion = tdc(tu_3rd_blood_transfusion_from_cancer_diagnosis_days),
  immobilisation = tdc(tu_1st_immobilisation_from_cancer_diagnosis_days), 
  immobilisation = tdc(tu_2nd_immobilisation_from_cancer_diagnosis_days), 
  immobilisation = tdc(tu_3rd_immobilisation_from_cancer_diagnosis_days), 
  recent_major_surgery = tdc(tu_1st_recent_major_surgery_from_cancer_diagnosis_days),
  recent_major_surgery = tdc(tu_2nd_recent_major_surgery_from_cancer_diagnosis_days),
  recent_major_surgery = tdc(tu_3rd_recent_major_surgery_from_cancer_diagnosis_days),
  thromboprophylaxis_hospital = tdc(tu_1st_thromboprophylaxis_hospital_from_cancer_diagnosis_days), 
  erythropoietin_tx = tdc(tu_1st_erythropoietin_tx_from_cancer_diagnosis_days),
  erythropoietin_tx = tdc(tu_2nd_erythropoietin_tx_from_cancer_diagnosis_days),
  erythropoietin_tx = tdc(tu_3rd_erythropoietin_tx_from_cancer_diagnosis_days)
  )
```


# Survival curves 

We will fit several survival curves using the Kaplan-Meier estimator. 

## VTE

```{r}
# Fit Kaplan-Meier estimator 
km_fit_vte = survfit(
  Surv(time = tstart, time2 = tstop, event = death) ~ 
    vte_event + 
    cluster(id), # ensures that the survival estimates account for the correlation within individuals, providing more robust results in the presence of repeated measurements
  data = survival_vte_tmerge)

km_fit_vte
```

This output contains several items:

- records: The total number of records in each group (vte_event=0 and vte_event=1).
- n.max: The maximum number of subjects at risk at any time during the observation period.
- n.start: The number of subjects at the start of the observation period.
- events: The number of events (deaths) observed.
- median: The median survival time (days).
- 0.95LCL and 0.95UCL: The lower and upper 95% confidence limits for the median survival time (days).


```{r}
km_summary = function(km_survfit) {
  
  # Obtain summary from KM estimator
  summary_fit = summary(km_survfit)

  formatted_summary = data.frame(
    time = summary_fit$time,
    n_risk = summary_fit$n.risk,
    n_event = summary_fit$n.event,
    survival = summary_fit$surv,
    std_error = summary_fit$std.err,
    lower_95CI = summary_fit$lower,
    upper_95CI = summary_fit$upper
  )
  
  # Show table with summary
  formatted_summary %>%
    kbl(caption = "Survival Analysis Summary") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                  full_width = FALSE) %>%
    column_spec(ncol(formatted_summary))
}
```


```{r}
# Show table with summary with all time points from Kaplan-Meier estimation
km_summary(km_fit_vte)
```


```{r}
get_robscore_pval = function(data, covariates, tstart = "tstart", tstop = "tstop", event = "death", cluster = "id", strata = NULL) {
  
  # Fit CPH model to extract robust score test p-value, since it is the best
  # way of dealing with left- and right-censored data
  
  # Construct formula
  covariates = paste(covariates, collapse = " + ")
    
  # Create formula for CPH model
  if (!is.null(strata)) {
    formula_string = paste0("Surv(", tstart, ", ", tstop, ", ", event, ") ~ ", covariates, " + strata(", strata, ") + cluster(", cluster, ")")
  } else {
    formula_string = paste0("Surv(", tstart, ", ", tstop, ", ", event, ") ~ ", covariates, " + cluster(", cluster, ")")
  }
  
  # Convert to formula object
  formula_string = as.formula(formula_string)
    
  # Train CPH model
  cph_fit = coxph(formula_string,data = data)

  # Get p-value from robust score test
  cph_tests_summary = summary(cph_fit)
  robscore_pval = cph_tests_summary$robscore[["pvalue"]]

  return(robscore_pval)
}
```


```{r}
# We perform the log-rank test separately, using coxph(), because it can handle left- and right-censored data
# Later, we need to manually add the p-value into the KM curves
km_pval = get_robscore_pval(data = survival_vte_tmerge, covariates = c("vte_event"))
```


```{r}
# jpeg("../graphs/time_dependent_covariate_analysis/vte_td_surv_analysis_KM_curve.jpeg", width = 6.5, height = 4, units = 'in', res = 700)
km_plot_vte = 
  ggsurvplot(
    fit = km_fit_vte,
    data = survival_vte_tmerge,
    xscale = 30,
    break.time.by = 60,
    censor = FALSE,
    # pval = TRUE, 
    # pval.method = TRUE,
     #pval.size = 4, 
    conf.int = TRUE,
    conf.int.alpha = 0.15,
    xlim = c(0, 540),
    surv.plot.height = 1.25, 
    tables.height = 0.25,
    legend.title = " ",
    legend.labs = c("No VTE", "VTE"),
    risk.table = "abs_pct", 
    risk.table.height = 0.3, 
    fontsize = 3,
    risk.table.col = "strata", 
    risk.table.y.text.col = TRUE,
    # linetype = "strata", 
    surv.median.line = "hv",
    xlab = "Time to death (months)",
    ylab = "Overall Survival Probability",
    ggtheme = theme_bw(),
    palette = c("black", "red")
  )

# Add p-value
km_plot_vte$plot = km_plot_vte$plot + 
  annotate(
    geom = "text", 
    x = 26,
    y = 0.3,
    label = "Log-rank",
    color = "black") + 
  annotate(
    geom = "text", 
    x = 28,
    y = 0.2,
    label = as.character(format(
      km_pval, 
      scientific = TRUE, 
      digits = 1)),
    color = "black")

# Customize risk table title 
km_plot_vte$table = 
  km_plot_vte$table +
  theme(plot.title = element_text(size = 10))

km_plot_vte

# dev.off()
```


## No VTE vs single VTE vs VTE recurrence

VTE recurrence is also a time-dependent covariate. 

```{r}
# KM estimation
km_fit_vte_recurrence = survfit(Surv(
  time = tstart, 
  time2 = tstop,
  event = death) ~ vte_recurrence + cluster(id), 
    id = id,
  data = survival_vte_tmerge)

km_fit_vte_recurrence
```


```{r}
# Get ...
km_pval_vte_recurrence = get_robscore_pval(survival_vte_tmerge, covariates = c("vte_recurrence"))
```


```{r}
# jpeg("../graphs/paper/KM_cat_recurrence.jpeg", width = 6.5, height = 4, units = 'in', res = 700)

km_plot_vte_recurrence = 
  ggsurvplot(
    fit = km_fit_vte_recurrence,
    data = survival_vte_tmerge,
    xscale = 30,
    break.time.by = 60,
    censor = FALSE,
    conf.int = FALSE,
    xlim = c(0, 540),
    # surv.plot.height = 1.25, 
    # tables.height = 0.25,
    legend.title = " ",
    legend.labs = c("No CAT", "CAT w/o recurrence", "CAT recurrence"),
    risk.table = "abs_pct", 
    risk.table.height = 0.3, 
    fontsize = 3,
    risk.table.col = "strata", 
    tables.y.text = FALSE,
    #tables.y.text.col = TRUE,
    risk.table.y.text.col = TRUE,
    #linetype = "strata", 
    surv.median.line = "hv",
    xlab = "Time (months)",
    ylab = "OS Probability",
    ggtheme = theme_bw(),
    palette = c("black", "red", "#FF6600")
    )

# Count number of patients of each category
n_vte_no_recurrence = sum(oncoth1_data$vte_recurrence == "No VTE recurrence")
n_vte_recurrence = sum(oncoth1_data$vte_recurrence == "VTE recurrence")


# Customize risk table title 
km_plot_vte_recurrence$table = 
  km_plot_vte_recurrence$table +
  theme(plot.title = element_text(size = 10))

# Add p-value and n of patient subgroups
km_plot_vte_recurrence$plot = 
  km_plot_vte_recurrence$plot + 
  # Log-rank p-value
  annotate(
    geom = "text", 
    x = 26,
    y = 0.3,
    label = "Log-rank",
    color = "black") + 
  annotate(
    geom = "text", 
    x = 28,
    y = 0.2,
    label = if (km_pval_vte_recurrence < 0.0001) {"< 0.0001"} else {km_pval_vte_recurrence},
    color = "black") + 
  # n subgroups
  annotate(
    geom = "text",
    size = 3.5,
    x = 530, 
    y = 0.99, 
    label = "n=302", 
    color = "black") + 
  annotate(
    geom = "text",
    size = 3.5,
    x = 530, 
    y = 0.91, 
    label = paste0("n=", n_vte_no_recurrence), 
    color = "red") +
  annotate(
    geom = "text",
    size = 3.5,
    x = 530, 
    y = 0.83, 
    label = paste0("n=", n_vte_recurrence), 
    color = "#FF6600")

km_plot_vte_recurrence

# dev.off()
```


```{r}
# Train CPH model to assess weight of VTE recurrence
# Adjust by age, sex, cancer type and stage
cph_vte_recurrence = coxph(Surv(
  time = tstart, 
  time2 = tstop, 
  event = death) ~ 
    age_when_cancer_dx + 
    gender +
    primary_tumor_simplified +
    tnm_stage_grouped +
    vte_event:vte_recurrence + # VTE recurrence only makes sense if there is VTE
    cluster(id),
  id = id,
  data = survival_vte_tmerge
  ) 
```

```{r}
# Test PH assumption
cox.zph(cph_vte_recurrence)
```


```{r}
# Inspect plot for violation of PH assumption
ggcoxzph(cox.zph(cph_vte_recurrence))
```


```{r}
# Show betas and p-values
cph_vte_recurrence %>% 
  gtsummary::tbl_regression(exp = TRUE)
```


```{r}
# C-index 
concordance(cph_vte_recurrence)
```


```{r}
# 18-month OS rate
summary(km_fit_vte_recurrence, times = 18*30.25)
```

## VTE & stage

```{r}
# Fit survival analysis model
km_fit_vte_stage = survfit(
  Surv(
    time = tstart, 
    time2 = tstop, 
    event = death) ~ 
    vte_event + 
    tnm_stage_two_groups + #test this primary_tumor_simplified
    cluster(id), 
  data = survival_vte_tmerge)

km_fit_vte_stage
```


```{r}
# Get p-value
km_pval_vte_stage = get_robscore_pval(survival_vte_tmerge, covariates = c("vte_event", "tnm_stage_two_groups")) 
```


```{r}
# #jpeg("./graphs/paper/KM_cat_and_stage.jpeg", width = 8, height = 4, units = 'in', res = 700)
# 
# # Custom KM 
# # tt <- oncoth1_data %>%
# #   group_by(tnm_stage_two_groups, patient_group) %>%
# #   summarize(count = n(), .groups = 'drop')
# 
# # Count n patients in each subgroup
# n_stages_i_ii_iii_no_vte = sum(
#   oncoth1_data$tnm_stage_two_groups == "I-II-III" & 
#     oncoth1_data$patient_group == "Control")
# 
# n_stages_i_ii_iii_vte = sum(
#   oncoth1_data$tnm_stage_two_groups == "I-II-III" & 
#     oncoth1_data$patient_group == "Case")
# 
# n_stages_iv_no_vte = sum(
#   oncoth1_data$tnm_stage_two_groups == "IV" & 
#     oncoth1_data$patient_group == "Control")
# 
# n_stages_iv_vte = sum(
#   oncoth1_data$tnm_stage_two_groups == "IV" & 
#     oncoth1_data$patient_group == "Case")
# 
# legend_labels_and_n = c(
#   paste0("Stages I-II-III w/o CAT (n=", n_stages_i_ii_iii_no_vte, ")"), 
#   paste0("Stage IV w/o CAT (n=", n_stages_iv_no_vte, ")"),
#   paste0("Stages I-II-III with CAT (n=", n_stages_i_ii_iii_vte, ")"), 
#   paste0("Stage IV with CAT (n=", n_stages_iv_vte, ")"))
# 
# #median_survival_days = surv_median(km_fit_vte_stage)
#   
# survplot_cat_stage = ggfortify::autoplot(
#   km_fit_vte_stage,
#   censor = FALSE,
#   conf.int = FALSE,
#   surv.size = 0.5,
#   surv.linetype = "strata") +
#   theme_bw() +
#   labs(
#     x = "Time (months)",
#     y = "OS probability",
#     title = "") +
#   theme(
#     plot.title = element_text(hjust = 0.5),
#     legend.title = element_text(hjust = 0.5, face = "bold"),
#     legend.text = element_text(size = 11),
#     legend.position = "right") +
#   scale_x_continuous(
#     limits = c(0, 605),
#     breaks = seq(from = 0, to = 600, by = 60),
#     labels = seq(from = 0, to = 20, by = 2)) +
#   scale_colour_manual(
#     name = "CAT and Stage",
#     labels = legend_labels_and_n,
#     values = c("black", "black", "red", "red")) +
#   scale_linetype_manual(
#     name = "CAT and Stage",
#     labels = legend_labels_and_n,
#     values = c("longdash", "dotted", "longdash", "dotted"))
# 
# # # Add log-rank p-value
# survplot_cat_stage = survplot_cat_stage +
#   # Log-rank p-value
#   annotate(
#     geom = "text",
#     size = 4,
#     x = 50,
#     y = 0.2,
#     label = "Log-rank",
#     color = "black") +
#   annotate(
#     geom = "text",
#     size = 4,
#     x = 50,
#     y = 0.15,
#     label = as.character(format(
#       km_pval_vte_stage, 
#       scientific = TRUE, 
#       digits = 1))
#     )
# 
# # Add median survival line
# survplot_cat_stage = survplot_cat_stage +
#   # Horizontal line
#   geom_segment(
#     aes(x = 0, y = 0.5, xend = 478, yend = 0.5),
#     linetype = "dashed",
#     size = 0.4) +
#   # Vertical lines
#   geom_segment(
#     aes(x = 478, y = 0, xend = 478, yend = 0.5),
#     linetype = "dashed",
#     size = 0.4) +
#   geom_segment(
#     aes(x = 231, y = 0, xend = 231, yend = 0.5),
#     linetype = "dashed",
#     size = 0.4)
# 
# survplot_cat_stage
# 
# #dev.off()
```


```{r}
# Get summary of KM estimator at 18 months
summary(km_fit_vte_stage, times = 18 * 30.25)
```

Stage IV heavily impacts the decrease in survival, more than having a VTE. Nevertheless, within the subgroups defined by these stages, having a VTE also significantly decreases survival.  


## VTE & primary tumor

```{r}
# Fit survival analysis model
km_fit_vte_vte_cancer_type = survfit(
  Surv(
    time = tstart, 
    time2 = tstop, 
    event = death) ~ 
    vte_event + 
    primary_tumor_simplified +
    cluster(id), 
  data = survival_vte_tmerge)

km_fit_vte_vte_cancer_type
```

```{r}
# Get robust score test p-value
km_pval_vte_cancer_type = get_robscore_pval(data = survival_vte_tmerge, covariates = c("vte_event", "primary_tumor_simplified"))
```


```{r}
# # We perform the log-rank test separately, because we need to manually insert the
# # p-value into the KM plot
# stratified_primary_tumor_cph_fit = coxph(Surv(
#   time = tstart, 
#   time2 = tstop, 
#   event = death) ~ 
#     vte_event + 
#     age_when_cancer_dx +
#     gender + 
#     tnm_stage_grouped +
#     primary_tumor_simplified + #test this primary_tumor_simplified
#     cluster(id),
#   id = id, 
#   data = survival_vte_tmerge)
# 
# stratified_primary_tumor_cph_tests_summary = summary(stratified_primary_tumor_cph_fit)
# 
# stratified_primary_tumor_cph_tests_summary$robscore[["pvalue"]]
```


```{r}
#jpeg("./graphs/time_dependent_covariate_analysis/stratified_primary_tumor_vte_td_surv_analysis_KM_curve.jpeg", width = 6.5, height = 4, units = 'in', res = 700)

survplot_cat_cancer_type = 
  ggsurvplot(
    fit = km_fit_vte_vte_cancer_type,
    data = survival_vte_tmerge,
    xscale = 30,
    break.time.by = 60,
    censor = FALSE,
    conf.int = FALSE,
    #conf.int.alpha = 0.15,
    xlim = c(0, 540),
    #surv.plot.height = 1.25, 
    #tables.height = 0.25,
    legend.title = " ",
    legend.labs = c("No VTE - Colorectal",
                    "No VTE - NSCLC",
                    "No VTE - Oesophago-gastric",
                    "No VTE - Pancreatic",
                    "VTE - Colorectal", 
                    "VTE - NSCLC", 
                    "VTE - Oesophago-gastric",
                    "VTE - Pancreatic"),
    linetype = "vte_event", 
    surv.median.line = "hv",
    xlab = "Time to death (months)",
    ylab = "Overall Survival Probability",
    ggtheme = theme_bw(), 
    palette = c("blue", "magenta", "orange", "steelblue", "blue", "magenta", "orange", "steelblue")
    )

# Add p-value
survplot_cat_cancer_type$plot = 
  survplot_cat_cancer_type$plot + 
  annotate(
    geom = "text", 
    x = 26,
    y = 0.3,
    label = "Log-rank",
    color = "black") + 
  annotate(
    geom = "text", 
    x = 28,
    y = 0.2,
    label = as.character(format(
      km_pval_vte_cancer_type, 
      scientific = TRUE, 
      digits = 1)),
    color = "black")

# Customize risk table title 
#stratified_stage_km_plot_vte$table = 
#  stratified_stage_km_plot_vte$table +
#  theme(plot.title = element_text(size = 10))

survplot_cat_cancer_type

#dev.off()
```

```{r}
# #jpeg("./graphs/paper/KM_cat_and_primary_tumor.jpeg", width = 8, height = 4, units = 'in', res = 700)
# 
# # Custom KM 
# 
# # Count n patients in each subgroup
# n_colorectal_no_vte = sum(
#   oncoth1_data$primary_tumor_simplified == "Colorectal" & 
#     oncoth1_data$patient_group == "Control")
# 
# n_colorectal_vte = sum(
#   oncoth1_data$primary_tumor_simplified == "Colorectal" & 
#     oncoth1_data$patient_group == "Case")
# 
# n_nsclc_no_vte = sum(
#   oncoth1_data$primary_tumor_simplified == "NSCLC" & 
#     oncoth1_data$patient_group == "Control")
# 
# n_nsclc_vte = sum(
#   oncoth1_data$primary_tumor_simplified == "NSCLC" & 
#     oncoth1_data$patient_group == "Case")
# 
# n_oesophagogastric_no_vte = sum(
#   oncoth1_data$primary_tumor_simplified == "Oesophago-gastric" & 
#     oncoth1_data$patient_group == "Control")
# 
# n_oesophagogastric_vte = sum(
#   oncoth1_data$primary_tumor_simplified == "Oesophago-gastric" & 
#     oncoth1_data$patient_group == "Case")
# 
# n_pancreatic_no_vte = sum(
#   oncoth1_data$primary_tumor_simplified == "Pancreatic" & 
#     oncoth1_data$patient_group == "Control")
# 
# n_pancreatic_vte = sum(
#   oncoth1_data$primary_tumor_simplified == "Pancreatic" & 
#     oncoth1_data$patient_group == "Case")
# 
# 
# legend_labels_and_n = c(
#   paste0("Colorectal w/o CAT (n=", n_colorectal_no_vte, ")"), 
#   paste0("Colorectal with CAT (n=", n_colorectal_vte, ")"),
#   paste0("NSCLC w/o CAT (n=", n_nsclc_no_vte, ")"), 
#   paste0("NSCLC with CAT (n=", n_nsclc_vte, ")"),
#   paste0("Oesophago-gastric w/o CAT (n=", n_oesophagogastric_no_vte, ")"), 
#   paste0("Oesophago-gastric with CAT (n=", n_oesophagogastric_vte, ")"),
#   paste0("Pancreatic w/o CAT (n=", n_pancreatic_no_vte, ")"), 
#   paste0("Pancreatic with CAT (n=", n_pancreatic_vte, ")")
#   )
# 
# #median_survival_days = surv_median(km_fit_vte_stage)
#   
# survplot_cat_cancer_type = autoplot(
#   km_fit_vte_vte_cancer_type,
#   censor = FALSE,
#   conf.int = FALSE,
#   surv.size = 0.5,
#   surv.linetype = "strata") +
#   theme_bw() +
#   labs(
#     x = "Time (months)",
#     y = "OS probability",
#     title = "") +
#   theme(
#     plot.title = element_text(hjust = 0.5),
#     legend.title = element_text(hjust = 0.5, face = "bold"),
#     legend.text = element_text(size = 11),
#     legend.position = "right") +
#   scale_x_continuous(
#     limits = c(0, 605),
#     breaks = seq(from = 0, to = 600, by = 60),
#     labels = seq(from = 0, to = 20, by = 2)) +
#   scale_colour_manual(
#     name = "CAT and Cancer type",
#   labels = legend_labels_and_n,
#     values = c("#F8766D", "#F8766D",
#                "#00BA42", "#00BA42",
#                "#00BBDD", "#00BBDD",
#                "#FF62BC", "#FF62BC")) +
#   scale_linetype_manual(
#     name = "CAT and Cancer type",
#     labels = legend_labels_and_n,
#     values = c("solid", "longdash",
#                "solid", "longdash",
#                "solid", "longdash",
#                "solid", "longdash"))
# 
# # Add log-rank p-value
# survplot_cat_cancer_type = survplot_cat_cancer_type +
#   # Log-rank p-value
#   annotate(
#     geom = "text",
#     size = 4,
#     x = 50,
#     y = 0.2,
#     label = "Log-rank",
#     color = "black") +
#   annotate(
#     geom = "text",
#     size = 4,
#     x = 50,
#     y = 0.15,
#     label = "<0.0001")
# 
# # Add median survival line
# survplot_cat_cancer_type = survplot_cat_cancer_type +
#   # Horizontal line
#   geom_segment(
#     aes(x = 0, y = 0.5, xend = 478, yend = 0.5),
#     linetype = "dashed",
#     size = 0.4) +
#   # Vertical lines
#   geom_segment(
#     aes(x = 478, y = 0, xend = 478, yend = 0.5),
#     linetype = "dashed",
#     size = 0.4) +
#   geom_segment(
#     aes(x = 231, y = 0, xend = 231, yend = 0.5),
#     linetype = "dashed",
#     size = 0.4)
# 
# survplot_cat_cancer_type
# 
# #dev.off()
```


This plot is quite messy, but we can see that for all 4 types of tumor median survival is lower when patients have one or more VTEs than when they have none.  

[CORREGIR]

Among the subgroup of patients that suffer VTE, pancreatic cancer patients are the ones that die sooner (median survival time of almost 6 months). It is followed by NSCLC patients (median survival of 10.5 months, approximately); colorectal (median survival of 15.5 months approximately) and oesophago-gastric patients (median survival time of almost 19 months).  

However, in the non-VTE patient's subgroup, pancreatic, NSCLC and oesophago-gastric have similar median survival times; whilst colorectal cancer patients have the best prognostic among all of them. This could also be related to the fact that the majority of colorectal cancer patients are in stage III (45.7%) and a lesser percentage (36.4%) are in stage IV. In the previous section, we have seen that stage IV cancer patients, regardless of the type of tumor, are the ones with shorter survival times.    

The p-value shows that having a VTE is significantly associated with a difference in survival between patients subgroups, regardless of the type of cancer.  


# Multivariate CPH regression


## Exploratory CPH regression [this is a mess, I don't know what I was doing]

In a linear model (like the Cox regression), you generally should limit yourself to about 1 candidate predictor per 15 events in your dataset.

https://stats.stackexchange.com/questions/178944/precisely-how-does-rs-coxph-handle-repeated-measures  

One approach to dealing with a violation of the proportional hazards assumption is to stratify by that variable. Including a strata() term will result in a separate baseline hazard function being fit for each level in the stratification variable. It will be no longer possible to make direct inference on the effect associated with that variable.  


```{r}

all_covariates_td_cph_reg = coxph(
  Surv(time = tstart, time2 = tstop, event = death) ~ 
    cluster(id) + 
    vte_event + 
    primary_tumor_simplified + # No significance along with       vte_event:tnm_stage_grouped
    #vte_event:primary_tumor_simplified:tnm_stage_two_groups + # No significance
    #vte_event:age_when_cancer_dx:menopausal_status_imp + 
    age_when_cancer_dx + 
    menopausal_status_imp +
    #age_when_cancer_dx:menopausal_status_imp + # No significance
    #age_when_cancer_dx:gender + # No significance
    #gender + 
    #gender:menopausal_status_imp +
    #ethnicity_grouped + 
    #weight + 
    #height + 
    #body_surface_area + 
    #bmi_value +
    #bmi_category + 
    performance_status_category_corrected_imp + 
    #major_surgery_in_medical_history + 
    #hormone_therapy + 
    #pregnancy + 
    #oral_contraceptive_tx + 
    #diabetes_mellitus + 
    #dyslipidemia + 
    #tobacco_use + 
    #copd + 
    #arterial_hypertension + 
    #chronic_cardiac_insufficiency + 
    #renal_insufficiency + 
    #khorana_risk_score_imp + 
    #two_groups_krs + 
    #tic_onco_imp + 
    #previous_onco_surgery + 
    tumor_surgically_removed + 
    #primary_tumor_simplified +
    #progression_according_to_clinical_stage + 
    #tnm_stage + 
    #tnm_stage_detailed + 
    tnm_stage_grouped + 
    #strata(tnm_stage_grouped, vte_event) + 
    #t_stage_grouped + 
    #n_stage_grouped + 
    #m_stage_grouped + 
    #histology_type_imp + 
    #mucinous_histology_imp + 
    #grade_histological_differentiation_imp + 
    #metastasis_dx + 
    #n_metastases + 
    #metastasis_adrenal_glands + 
    #metastasis_bones +
    #metastasis_brain + 
    #metastasis_liver + 
    #metastasis_lung + 
    #metastasis_lymph_nodes + 
    #metastasis_peritoneum + 
    #metastasis_pleura + 
    #metastasis_skin + 
    #metastasis_soft_tissues + 
    #other_metastases + 
    #catheter_device_imp + 
    #venous_insufficiency_imp + 
    family_background_vte + 
    #family_background_vte_n + 
    #family_background_vte_all_relatives +
    #family_background_VTE_father + 
    #family_background_VTE_mother + 
    #family_background_VTE_siblings + 
    #family_background_VTE_offspring + 
    #family_background_VTE_other_relatives +
    previous_vte, # + 
    ##n_previous_ate +
    #previous_ate_type +
    #previous_ate + 
    #cva_ate + 
    #myocardial_infarction_ate + 
    #pad_ate + 
    #tia_ate + 
    #other_thromb_ate + 
    #anticoag_tx_vte + 
    #anticoag_tx_vte_drugs + 
    #anticoag_tx_cardiopathy + 
    #anticoag_tx_other_causes + 
    #anticoag_tx_reason + 
    #anticoag_tx_apixaban + 
    #anticoag_tx_dabigatran + 
    #anticoag_tx_lmwh + 
    #anticoag_tx_lmwh_dosage + 
    #anticoag_tx_vit_k_antag + 
    #anticoag_tx_other_drugs + 
    #anticoag_tx_currently + 
    #n_antiaggreg_tx + 
    #n_antiaggreg_tx,
    #antiaggreg_tx_reason + 
    #antiaggreg_tx_cardiopathy + 
    #antiaggreg_tx_cva + 
    #antiaggreg_tx_other_causes + 
    #antiaggreg_tx_currently
    #blood_transfusion + # Correlated with leukocytosis, low red cells, low hemoglobin, etc.
    #immobilisation + # Correlated with PS
    #recent_major_surgery + 
    #thromboprophylaxis_hospital, # + 
    #erythropoietin_tx, # Correlated with low red blood cells
  #singular.ok = TRUE,
  id = id,
  data = survival_vte_tmerge)


all_covariates_td_cph_reg %>% 
  gtsummary::tbl_regression(exp = TRUE)

```


```{r}
cox.zph(all_covariates_td_cph_reg)
```

[Investigate primary_tumor:previous_onco_surgery y tnm_stage:previous_onco_surgery.]

```{r}
concordance(all_covariates_td_cph_reg)
```



```{r}
#glm(death ~ ., family=binomial(link=logit), data=survival_vte_tmerge)
```


```{r}
# Multicollinearity
rms::vif(all_covariates_td_cph_reg)
```


```{r}
cox.zph(all_covariates_td_cph_reg)
```

## Prior selection of features... [variability? correlation? multicollinearity?]


### Variance per feature

```{r}
# Convert categorical variables into dummies (one-hot encoding)
survival_vte_tmerge_dummies = survival_vte_tmerge %>%
  # Remove useless variables
  select(-c(id, tstart, tstop, contains("tu_"))) %>%
  # Convert KRS to numeric
  mutate(khorana_risk_score_imp = as.numeric(khorana_risk_score_imp)) %>%
  # Create dummies for all categorical variables (character and factors)
  fastDummies::dummy_cols(., remove_first_dummy = TRUE, remove_selected_columns = TRUE)
```


```{r}
# Variance per feature
variance_per_feature = sapply(survival_vte_tmerge_dummies, function (x) var(x, na.rm = TRUE))
variance_per_feature = variance_per_feature[order(variance_per_feature)] 

# Threshold
variance_threshold = 0.05  

# Variables with less than threshold variance, ordered from less to more
variance_per_feature[order(variance_per_feature[variance_per_feature < variance_threshold])]
```


### Correlation plot

```{r}
# Correlation matrix
oncoth1_correlations_vars = survival_vte_tmerge_dummies %>%
  # Select relevant variables
  select(
    age_when_cancer_dx, 
    weight, 
    height, 
    body_surface_area, 
    bmi_value, 
    khorana_risk_score_imp, 
    death, 
    vte_event, 
    blood_transfusion, 
    immobilisation, 
    recent_major_surgery, 
    thromboprophylaxis_hospital, 
    erythropoietin_tx, 
    `age_quartiles_61-69`, 
    `age_quartiles_70-93`, 
    `age_when_cancer_dx_50_Older or 50 years old`, 
    `age_when_cancer_dx_65_Older or 65 years old`, 
    gender_Female, 
    menopausal_status_imp_Pre-menopausal,
    menopausal_status_imp_Peri-menopausal, 
    menopausal_status_imp_Post-menopausal, 
    bmi_category_Normal, 
    bmi_category_Overweight, 
    bmi_category_Obese, 
    performance_status_category_corrected_imp_1, 
    performance_status_category_corrected_imp_2, 
    diabetes_mellitus_Yes, 
    dyslipidemia_Yes, 
    `tobacco_use_imp_Former smoker`, 
    `tobacco_use_imp_Active smoker`, 
    `tobacco_use_imp_grouped_Never`, 
    copd_imp_Yes, 
    arterial_hypertension_Yes, 
    chronic_cardiac_insufficiency_Yes, 
    renal_insufficiency_Yes, 
    previous_onco_surgery_Yes, 
    primary_tumor_simplified_NSCLC, 
    `primary_tumor_simplified_Oesophago-gastric`, 
    primary_tumor_simplified_Pancreatic, 
    tumor_surgically_removed_Yes, 
    `progression_according_to_clinical_stage_imp_Locally advanced`,
    progression_according_to_clinical_stage_imp_Metastatic, 
    tnm_stage_II, 
    tnm_stage_III, 
    tnm_stage_IV, 
    tnm_stage_grouped_III, 
    tnm_stage_grouped_IV, 
    tnm_stage_two_groups_IV, 
    histology_type_imp_Adenocarcinoma, 
    histology_type_imp_Epidermoid, mucinous_histology_imp_Yes, 
    `grade_histological_differentiation_imp_Moderately differentiated`,
    `grade_histological_differentiation_imp_Poorly differentiated`, 
    metastasis_adrenal_glands_Yes, 
    metastasis_bones_Yes, 
    metastasis_brain_Yes, 
    metastasis_liver_Yes, 
    metastasis_lung_Yes, 
    metastasis_lymph_nodes_Yes, 
    metastasis_peritoneum_Yes, 
    metastasis_pleura_Yes, 
    metastasis_skin_Yes, 
    metastasis_soft_tissues_Yes, 
    other_metastases_Yes, 
    catheter_device_imp_Yes, 
    venous_insufficiency_imp_Yes, 
    n_comorbidities_1, 
    `n_comorbidities_2+`, 
    family_background_vte_Yes, 
    previous_vte_Yes, 
    previous_ate_Yes,
    anticoag_tx_currently_Yes,
    antiaggreg_tx_currently_Yes, 
    `vte_recurrence_No VTE recurrence`, 
    `vte_recurrence_VTE recurrence`
    ) %>%
  cor(.)

# Correlation plot
corrplot::corrplot(oncoth1_correlations_vars, method = "circle")
```



### Association between categorical variables using Cramer's V

```{r}
# Do correlation between CVC and tumor surgically removed with primary tumor
oncoth1_corr_vars = oncoth1_data %>% 
  select(id, primary_tumor_simplified, catheter_device, tumor_surgically_removed)

# Calculate CramÃ©r's V
# Close to 0: Weak or no association.
# Around 0.1: Small association.
# Around 0.3: Moderate association.
# Around 0.5: Strong association.
# Close to 1: Very strong or perfect association.

# Primary tumor and CVC
contingency_table1 <- table(
  oncoth1_corr_vars$primary_tumor_simplified,
  oncoth1_corr_vars$catheter_device
  )

cramers_v1 <- round(sqrt(chisq.test(contingency_table1)$statistic / sum(contingency_table1)), digits = 4)
print(paste("Cramer's V for cancer type and CVC =", cramers_v1))


# Primary tumor and tumor surgically removed
contingency_table2 <- table(
  oncoth1_corr_vars$primary_tumor_simplified,
  oncoth1_corr_vars$tumor_surgically_removed
  )

cramers_v2 <- round(sqrt(chisq.test(contingency_table2)$statistic / sum(contingency_table2)), digits = 4)
print(paste("Cramer's V for cancer type and surgical resection of tumor =", cramers_v2))
```



## Stepwise feature selection CPH [careful with StepReg version]

StepReg vignette: 

https://cran.r-project.org/web/packages/StepReg/vignettes/StepReg.html

```{r}
# Create dataset
survival_vte_tmerge_stepwise = survival_vte_tmerge %>%
  filter(!is.na(n_comorbidities))

# Do one-hot encoding with primary tumour
survival_vte_tmerge_stepwise = fastDummies::dummy_cols(survival_vte_tmerge_stepwise, select_columns = "primary_tumor_simplified")

# Rename with proper format
survival_vte_tmerge_stepwise %<>%
  rename(primary_tumor_simplified_Oesophagogastric = `primary_tumor_simplified_Oesophago-gastric`)

# Delete variables with time until event 
# They contain NAs that throw an error when training model
# This did not happen before
# survival_vte_tmerge_stepwise %<>%
#   select(-starts_with("tu_"))

```





### Training/test set partition and CV

See if there is consistency in variable selection and predictive capability of CV partitions, as well as with test set.

```{r}
# Set seed for reproducibility and consistency in results
set.seed(2828)
```


```{r}
# Target distribution when event of interest is death
table(oncoth1_data$patient_status_at_end_study_simplified, useNA = "always")
```


```{r}
# Partition data with repeated rows per patient into training and test set

# Get unique IDs
unique_ids <- unique(survival_vte_tmerge_stepwise$id)

# Randomly assign each unique ID to either train or test
train_ids <- sample(unique_ids, size = floor(0.8 * length(unique_ids))) # 80% for training
test_ids <- setdiff(unique_ids, train_ids)  # Remaining IDs for testing

# Partition the data into train and test sets based on the assigned IDs
stepwise_training_set <- survival_vte_tmerge_stepwise %>% filter(id %in% train_ids)
stepwise_testing_set <- survival_vte_tmerge_stepwise %>% filter(id %in% test_ids)

# Check that IDs are not in training and test sets
stopifnot(
  identical(
    sort(unique(stepwise_training_set$id)), sort(unique(stepwise_testing_set$id))) == FALSE)
```


```{r}
# Create folds for k-fold CV

# Create a grouping variable for each ID
group_var <- as.numeric(factor(stepwise_training_set$id))

# Determine the unique IDs and shuffle them randomly to ensure a balanced distribution across the folds
# Get unique IDs
folds_unique_ids <- unique(group_var)

# Shuffle the unique IDs randomly
folds_shuffled_ids <- sample(folds_unique_ids)

# Divide the shuffled IDs into five bins
stepwise_folds <- cut(folds_shuffled_ids, breaks = 10, labels = FALSE)
```


```{r}
# Initialize a vector to store the evaluation results
stepwise_cv_vars_results <- vector("list", length = 10)
stepwise_cv_cindex_results <- vector("list", length = 10)
# stepwise_cv_vif_results <- vector("list", length = 10)

for (i in 1:10) {
  # Get the validation IDs
  validation_ids <- unique_ids[stepwise_folds == i]
  
  # Get the validation fold
  validation_fold <- stepwise_training_set[stepwise_training_set$id %in% validation_ids, ]
  
  # Get the training fold
  training_fold <- stepwise_training_set[!(stepwise_training_set$id %in% validation_ids), ]
  
  # print("Training")
  # print(head(training_fold, n = 10))
  # 
  # print("Validation")
  # print(head(validation_fold, n = 10))
  
  # Check that IDs are not in training and test sets
  stopifnot(
    identical(
      sort(unique(training_fold$id)), sort(unique(validation_fold$id))) == FALSE)
  
  # Train your model on the training fold
  stepwise_model = StepReg::stepwiseCox(
    formula = Surv(time = tstart, time2 = tstop, event = death) ~
    vte_event +
    # vte_recurrence +
    # vte_event:vte_recurrence +
    age_when_cancer_dx +
    # age_quartiles + 
    # age_when_cancer_dx_50 +
    # age_when_cancer_dx_65 +
    gender + # Collinear with menopausal status
    # menopausal_status_imp +
    # weight +
    # height +
    bmi_value +
    performance_status_category_corrected_imp +
    # diabetes_mellitus + # Confounder
    dyslipidemia +
    tobacco_use_imp +
    # tobacco_use_imp_grouped +
    copd_imp +
    arterial_hypertension +
    # chronic_cardiac_insufficiency + # Low variance
    # renal_insufficiency + # Low variance
    venous_insufficiency_imp +
    n_comorbidities +
    # khorana_risk_score_imp + 
    # two_groups_krs +
    previous_onco_surgery +
    tumor_surgically_removed + 
    # primary_tumor_simplified +
    primary_tumor_simplified_Colorectal +
    primary_tumor_simplified_NSCLC +
    primary_tumor_simplified_Oesophagogastric +
    primary_tumor_simplified_Pancreatic +
    # progression_according_to_clinical_stage_imp + # too wide CI
    # tnm_stage +
    # tnm_stage_grouped +
    tnm_stage_two_groups +
    # histology_type_imp +
    mucinous_histology_imp +
    # grade_histological_differentiation_imp + # violates PH assumption
    # n_metastases_grouped + # confounder, possibly correlated to pTNM stage
    # metastasis_bones +
    # metastasis_liver +
    # metastasis_lung +
    # metastasis_lymph_nodes +
    # metastasis_peritoneum +
    # catheter_device_imp + # quite correlated with tumor type, as Cramer's V indicates
    family_background_vte +
    previous_vte +
    previous_ate +
    anticoag_tx_currently +
    antiaggreg_tx_currently, 
    # blood_transfusion + # Correlated with low blood cells, low hemoglobin, etc. CONFOUNDER
    # immobilisation + # Correlated with PS. Also, CONFOUNDER
    # recent_major_surgery + # Low variance
    # thromboprophylaxis_hospital + # CONFOUNDER
    # erythropoietin_tx,
    data = training_fold,
    # include = "primary_tumor_simplified",
    selection = "bidirection",
    select = "AIC", 
    method = "efron"
    )
  
  # Save selected variables
  selected_variables = unname(unlist(stepwise_model$`Selected Varaibles`))
  # print(selected_variables)
  
  # Fit model with selected variables in this fold
  # Create formula
  fold_pcox_formula = as.formula(
    sprintf('%s ~ %s', 'Surv(time = tstart, time2 = tstop, event = death)',
            paste(selected_variables, collapse = " + ")))
  
  # Fit model
  fold_cph_model = coxph(
    formula = fold_pcox_formula, 
    id = id,
    data = validation_fold
  )
  
  # VIF
  vif_results = car::vif(fold_cph_model)
  print(vif_results)
  
  # Make predictions on the validation fold
  # The result is the hazard of suffering the event. It's difficult to interpret
  predictions <- predict(fold_cph_model, newdata = validation_fold)
  # print(predictions)
  
  # Evaluate the predictions
  # C-index
  fold_cindex <- concordance(fold_cph_model, newdata = validation_fold)
  # print(fold_cindex$concordance)
  
  # Likelihood ratio test (LRT)
  # fold_lrt <- anova(fold_cph_model)
  # fold_lrt_p_value <- fold_lrt$`Pr(>Chisq)`[2]  # P-value for the model
  # print(fold_lrt_p_value)
  
  # Store the evaluation result
  stepwise_cv_vars_results[[i]] = selected_variables
  stepwise_cv_cindex_results[[i]] = fold_cindex$concordance
  # stepwise_cv_vif_results[[i]] = as.data.frame(vif_results)

}
```

Age by itself is not considered relevant.

Patients grouped by aged with 65 years old as threshold is not a very important variable. However, when the threshold is 50 years old, it is selected as important, with patients equal or older than 50 y.o. being protected against death. 

This strange result may be due to the tumor type:

                              Colorectal NSCLC Oesophago-gastric Pancreatic
  Younger than 50 years old         11     5                 9          8
  Older or 50 years old            151    82                60         64


```{r}
# Variable selection frequency across 10-fold CV
stepwise_var_selection_freq = as.data.frame(table(unlist(stepwise_cv_vars_results)))
stepwise_var_selection_freq %<>% arrange(desc(Freq))
knitr::kable(stepwise_var_selection_freq)
```


```{r}
# Mean C-index across 10-fold CV
mean(unlist(stepwise_cv_cindex_results))
```


```{r}
# Convert variable from factor to binary
# stepwise_training_set$mucinous_histology_imp = ifelse(stepwise_training_set$mucinous_histology_imp == "No", 0, 1)
```


```{r}
# Relevel factor
# stepwise_training_set$mucinous_histology_imp = relevel(stepwise_training_set$mucinous_histology_imp, ref = "Yes")
```


```{r}
# Final model with most frequently selected variables
stepwise_cv_cph_final_model = coxph(
  Surv(time = tstart, 
       time2 = tstop, 
       event = death) ~ 
    cluster(id) + 
    vte_event + # :vte_recurrence + # 
    performance_status_category_corrected_imp +
    primary_tumor_simplified +
    tnm_stage_two_groups +
    tumor_surgically_removed +
    venous_insufficiency_imp +
    mucinous_histology_imp,
  id = id,
  data = stepwise_training_set
  )

# Check proportional hazards assumption for Cox model
cox.zph(stepwise_cv_cph_final_model)

# Show HR and 95% CI
stepwise_cv_cph_final_model %>% 
  gtsummary::tbl_regression(exp = TRUE)
```


```{r}
# Does not work with models where there is interaction between variables
vif_results = car::vif(stepwise_cv_cph_final_model)
vif_results
```


```{r}
# C-index in testing set
concordance(stepwise_cv_cph_final_model, newdata = stepwise_testing_set)
```


```{r}
# AIC(final_cph_model)
```


```{r}
#AICcmodavg::aictab(final_cph_model)
```


```{r}
# # Predict survival probabilities for different groups
# # Does not work with models where there is interaction between variables
# stepwise_model_predicted_survival = survfit(stepwise_cv_cph_final_model)
# 
# # Plot survival curves
# # It cannot be done because I cannot apply survfit() to model with variable's interacions
# ggsurvplot(
#   stepwise_model_predicted_survival,
#   data = stepwise_training_set,
#   title = "Survival Curves with Interaction",
#   xlab = "Time",
#   ylab = "Survival Probability",
#   risk.table = TRUE,
#   risk.table.title = "Group Comparison"
#   )
```


```{r}
# https://stat.ethz.ch/R-manual/R-devel/library/survival/html/predict.coxph.html
# Choices are the linear predictor ("lp"), the risk score exp(lp) ("risk"), the expected number of events given the covariates and follow-up time ("expected"), and the terms of the linear predictor ("terms"). The survival probability for a subject is equal to exp(-expected)
# stepwise_pred = predict(
#   object = stepwise_cv_cph_final_model, 
#   newdata = stepwise_testing_set, 
#   se.fit = TRUE,
#   type = "survival"
#   )
# 
# # Get probabilities and SE
# stepwise_testing_set$prob = stepwise_pred$fit
# stepwise_testing_set$lcl = stepwise_pred$fit - 1.96 * stepwise_pred$se.fit
# stepwise_testing_set$ucl = stepwise_pred$fit + 1.96 * stepwise_pred$se.fit
```


```{r}
yhat <- predict(
  stepwise_cv_cph_final_model,
  newdata = stepwise_testing_set,
  se.fit = TRUE,
  reference = "zero"
  )

yy <- yhat$fit + outer(yhat$se.fit, c(0, -1.96, 1.96), '*')
yy
```



